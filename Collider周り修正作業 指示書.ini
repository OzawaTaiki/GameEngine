Collider周り修正作業 指示書
目的
既存のUIBase依存Collider実装をUIElement対応に修正し、Component設計に統合する。
回転機能は除外する。

前提条件

既存のCollider実装（IUICollider, UIRectangleCollider等）が存在
UIElementクラスが実装済み
UIComponentクラスが実装済み


作業フェーズ
Phase 1: インターフェース修正（30分）
1-1. IUICollider.h の修正
ファイル: Features/UI/Collider/Interface/IUICollider.h
修正内容:

前方宣言の変更

cpp// 修正前
class UIBase;

// 修正後
class UIElement;

ColliderType enumの修正

cppenum class ColliderType
{
    Rectangle,
    Circle,
    Ellipse,
    // Parallelogram,  // ← 削除（回転が必要）
    Quad,
    ConvexPolygon,
    
    Max
};

UpdateCache()の引数変更

cpp// 修正前
virtual void UpdateCache(const UIBase* _uiBase) = 0;

// 修正後
virtual void UpdateCache(const UIElement* _uiElement) = 0;
確認項目:

 コンパイルエラーが出ることを確認（他のファイルが未修正なので正常）


Phase 2: Rectangle Collider修正（1時間）
2-1. UIRectangleCollider.h の修正
ファイル: Features/UI/Collider/UIRectangleCollider.h
修正内容:
cpp// includeの追加（必要であれば）
class UIElement;  // 前方宣言

// UpdateCache()の引数変更
void UpdateCache(const UIElement* _uiElement) override;
2-2. UIRectangleCollider.cpp の修正
ファイル: Features/UI/Collider/UIRectangleCollider.cpp
修正内容:

includeの変更

cpp// 修正前
#include <Features/UI/UIBase.h>

// 修正後
#include <UI/UIElement.h>  // パスは実際の構造に合わせる

UpdateCache()の実装変更

cppvoid UIRectangleCollider::UpdateCache(const UIElement* _uiElement)
{
    if (transformMode_ == TransformMode::UIDependent)
    {
        // 修正前（UIBaseのメソッド使用）
        // leftTop_ = _uiBase->GetLeftTopPos();
        // rightBottom_ = _uiBase->GetRightBottomPos();
        
        // 修正後（UIElementから計算）
        Vector2 pos = _uiElement->GetWorldPosition();
        Vector2 size = _uiElement->GetSize();
        
        leftTop_ = pos;
        rightBottom_ = pos + size;
    }
    else
    {
        // 独立モードの修正
        Vector2 pos = _uiElement->GetWorldPosition();
        Vector2 size = _uiElement->GetSize();
        Vector2 center = pos + size * 0.5f + localOffset_;
        Vector2 halfSize = localSize_ * 0.5f;
        
        leftTop_ = center - halfSize;
        rightBottom_ = center + halfSize;
    }
}
確認項目:

 コンパイルが通る
 IsPointInside()の動作は変更なし


Phase 3: Circle Collider修正（1時間）
3-1. UICircleCollider.h の修正
ファイル: Features/UI/Collider/UICircleCollider.h
修正内容:
cppvoid UpdateCache(const UIElement* _uiElement) override;
3-2. UICircleCollider.cpp の修正
ファイル: Features/UI/Collider/UICircleCollider.cpp
修正内容:

includeの変更

cpp// 修正前
#include <Features/UI/UIBase.h>

// 修正後
#include <UI/UIElement.h>

UpdateCache()の実装変更

cppvoid UICircleCollider::UpdateCache(const UIElement* _uiElement)
{
    if (transformMode_ == TransformMode::UIDependent)
    {
        // 修正前
        // center_ = _uiBase->GetCenterPos();
        // Vector2 size = _uiBase->GetSize();
        
        // 修正後
        Vector2 pos = _uiElement->GetWorldPosition();
        Vector2 size = _uiElement->GetSize();
        center_ = pos + size * 0.5f;  // 中心座標を計算

        // 半径計算（変更なし）
        radius_ = (size.x < size.y) ? (size.x * 0.5f) : (size.y * 0.5f);
    }
    else
    {
        // 独立モードの修正
        Vector2 pos = _uiElement->GetWorldPosition();
        Vector2 size = _uiElement->GetSize();
        center_ = pos + size * 0.5f + localOffset_;
        radius_ = independentRadius_;
    }
}
確認項目:

 コンパイルが通る
 IsPointInside()の動作は変更なし


Phase 4: 残りのCollider修正（2-3時間）
同様の手順で以下を修正:
4-1. UIEllipseCollider

UIEllipseCollider.h - UpdateCache引数変更
UIEllipseCollider.cpp - include変更 + UpdateCache実装変更

4-2. UIQuadCollider

UIQuadCollider.h - UpdateCache引数変更
UIQuadCollider.cpp - include変更 + UpdateCache実装変更

4-3. UIConvexPolygonCollider

UIConvexPolygonCollider.h - UpdateCache引数変更
UIConvexPolygonCollider.cpp - include変更 + UpdateCache実装変更

共通の修正パターン:
cpp// GetCenterPos() の置き換え
// 修正前
Vector2 center = _uiBase->GetCenterPos();

// 修正後
Vector2 pos = _uiElement->GetWorldPosition();
Vector2 size = _uiElement->GetSize();
Vector2 center = pos + size * 0.5f;

// GetLeftTopPos() の置き換え
// 修正前
Vector2 leftTop = _uiBase->GetLeftTopPos();

// 修正後
Vector2 leftTop = _uiElement->GetWorldPosition();

// GetRightBottomPos() の置き換え
// 修正前
Vector2 rightBottom = _uiBase->GetRightBottomPos();

// 修正後
Vector2 pos = _uiElement->GetWorldPosition();
Vector2 size = _uiElement->GetSize();
Vector2 rightBottom = pos + size;

Phase 5: Parallelogram削除（30分）
5-1. UIParallelogramCollider削除
作業:

 UIParallelogramCollider.h を削除
 UIParallelogramCollider.cpp を削除

5-2. UIColliderFactory.cpp の修正
ファイル: Features/UI/Collider/UIColliderFactory.cpp
修正内容:

includeの削除

cpp// この行を削除
#include <Features/UI/Collider/UIParallelogramCollider.h>

Create()関数の修正

cppstd::unique_ptr<IUICollider> UIColliderFactory::Create(ColliderType type)
{
    switch (type)
    {
        case ColliderType::Rectangle:
            return std::make_unique<UIRectangleCollider>();
        case ColliderType::Circle:
            return std::make_unique<UICircleCollider>();
        case ColliderType::Ellipse:
            return std::make_unique<UIEllipseCollider>();
        // case ColliderType::Parallelogram:  // ← 削除
        //     return std::make_unique<UIParallelogramCollider>(tempSkew_);
        case ColliderType::Quad:
            return std::make_unique<UIQuadCollider>();
        case ColliderType::ConvexPolygon:
            return std::make_unique<UIConvexPolygonCollider>();
        default:
            return std::make_unique<UIRectangleCollider>();
    }
}

GetTypeName()関数の修正

cppconst char* UIColliderFactory::GetTypeName(ColliderType type)
{
    switch (type)
    {
        case ColliderType::Rectangle:
            return "Rectangle";
        case ColliderType::Circle:
            return "Circle";
        case ColliderType::Ellipse:
            return "Ellipse";
        // case ColliderType::Parallelogram:  // ← 削除
        //     return "Parallelogram";
        case ColliderType::Quad:
            return "Quad";
        case ColliderType::ConvexPolygon:
            return "ConvexPolygon";
        default:
            return "Unknown";
    }
}

ImGuiSelectCollider()関数の修正

cppconst char* items[] = {
    GetTypeName(ColliderType::Rectangle),
    GetTypeName(ColliderType::Circle),
    GetTypeName(ColliderType::Ellipse),
    // GetTypeName(ColliderType::Parallelogram),  // ← 削除
    GetTypeName(ColliderType::Quad),
    GetTypeName(ColliderType::ConvexPolygon)
};

tempSkew_の削除（使われなくなったので）

cpp// ヘッダーとcppから削除
// static Vector2 tempSkew_;
5-3. UIColliderSerializer.cpp の修正
ファイル: Features/UI/Collider/UIColliderSerializer.cpp
修正内容:

includeの削除

cpp// この行を削除
#include "UIParallelogramCollider.h"

to_json()関数の修正

cppvoid to_json(json& _j, const ColliderType& _type)
{
    switch (_type)
    {
    case ColliderType::Rectangle:
        _j = "Rectangle";
        break;
    case ColliderType::Circle:
        _j = "Circle";
        break;
    case ColliderType::Ellipse:
        _j = "Ellipse";
        break;
    // case ColliderType::Parallelogram:  // ← 削除
    //     _j = "Parallelogram";
    //     break;
    case ColliderType::Quad:
        _j = "Quad";
        break;
    case ColliderType::ConvexPolygon:
        _j = "ConvexPolygon";
        break;
    default:
        _j = "Unknown";
        break;
    }
}

from_json()関数の修正

cppvoid from_json(const json& _j, ColliderType& _type)
{
    std::string typeStr = _j.get<std::string>();
    if (typeStr == "Rectangle")
        _type = ColliderType::Rectangle;
    else if (typeStr == "Circle")
        _type = ColliderType::Circle;
    else if (typeStr == "Ellipse")
        _type = ColliderType::Ellipse;
    // else if (typeStr == "Parallelogram")  // ← 削除
    //     _type = ColliderType::Parallelogram;
    else if (typeStr == "Quad")
        _type = ColliderType::Quad;
    else if (typeStr == "ConvexPolygon")
        _type = ColliderType::ConvexPolygon;
    else
        _type = ColliderType::Rectangle;
}

CreateCollider()とFromCollider()のParallelogram部分を削除

確認項目:

 コンパイルが通る
 既存のParallelogram使用箇所がないか検索


Phase 6: ColliderComponent実装（2-3時間）
6-1. ColliderComponent.h 作成
ファイル: UI/Component/ColliderComponent.h
内容:
cpp#pragma once
#include "UIComponent.h"
#include <Features/UI/Collider/Interface/IUICollider.h>
#include <Features/UI/Collider/UIColliderFactory.h>
#include <memory>

/// <summary>
/// Collider機能を提供するComponent
/// 既存のIUIColliderをラップして使用
/// </summary>
class ColliderComponent : public UIComponent {
public:
    /// <summary>
    /// コンストラクタ
    /// </summary>
    /// <param name="type">Colliderの種類</param>
    ColliderComponent(ColliderType type = ColliderType::Rectangle);
    ~ColliderComponent() override = default;
    
    void Initialize() override;
    void Update() override;
    void DrawImGui() override;
    
    /// <summary>
    /// 点が内側にあるかを判定
    /// </summary>
    bool IsHit(const Vector2& worldPos) const;
    
    /// <summary>
    /// サイズ設定（Rectangle用）
    /// </summary>
    void SetSize(const Vector2& size);
    Vector2 GetSize() const;
    
    /// <summary>
    /// オフセット設定
    /// </summary>
    void SetOffset(const Vector2& offset);
    Vector2 GetOffset() const;
    
    /// <summary>
    /// Collider種類を変更
    /// </summary>
    void SetColliderType(ColliderType type);
    ColliderType GetColliderType() const { return colliderType_; }
    
    /// <summary>
    /// デバッグ描画の有効/無効
    /// </summary>
    void SetDebugDraw(bool enable) { debugDraw_ = enable; }
    bool IsDebugDraw() const { return debugDraw_; }
    
    /// <summary>
    /// 既存Colliderへの直接アクセス（高度な設定用）
    /// </summary>
    IUICollider* GetCollider() { return collider_.get(); }
    const IUICollider* GetCollider() const { return collider_.get(); }
    
private:
    std::unique_ptr<IUICollider> collider_;
    ColliderType colliderType_;
    bool debugDraw_ = false;
    
    /// <summary>
    /// Colliderのサイズを自動設定
    /// </summary>
    void InitializeColliderSize();
};
6-2. ColliderComponent.cpp 作成
ファイル: UI/Component/ColliderComponent.cpp
内容:
cpp#include "ColliderComponent.h"
#include "UIElement.h"
#include <Features/UI/Collider/UIRectangleCollider.h>
#include <Features/UI/Collider/UICircleCollider.h>
#include <Features/UI/Collider/UIEllipseCollider.h>
#include <Features/UI/Collider/UIQuadCollider.h>
#include <Features/UI/Collider/UIConvexPolygonCollider.h>

ColliderComponent::ColliderComponent(ColliderType type)
    : colliderType_(type)
{
    collider_ = UIColliderFactory::Create(type);
}

void ColliderComponent::Initialize()
{
    assert(owner_ != nullptr);
    assert(collider_ != nullptr);
    
    // サイズ未設定なら自動設定
    InitializeColliderSize();
    
    #ifdef _DEBUG
    std::cout << "[ColliderComponent] Initialized on '" << owner_->GetName() 
              << "' with type: " << UIColliderFactory::GetTypeName(colliderType_) 
              << std::endl;
    #endif
}

void ColliderComponent::InitializeColliderSize()
{
    Vector2 ownerSize = owner_->GetSize();
    
    switch (colliderType_)
    {
    case ColliderType::Rectangle:
    {
        auto* rect = static_cast<UIRectangleCollider*>(collider_.get());
        // サイズが{0,0}なら自動設定
        if (rect->GetLocalSize() == Vector2(0, 0))
        {
            rect->SetLocalSize(ownerSize);
        }
        break;
    }
    
    case ColliderType::Circle:
    {
        auto* circle = static_cast<UICircleCollider*>(collider_.get());
        // 半径が0なら自動設定
        if (circle->GetIndependentRadius() == 0.0f)
        {
            float radius = (ownerSize.x < ownerSize.y) ? (ownerSize.x * 0.5f) : (ownerSize.y * 0.5f);
            circle->SetRadius(radius);
        }
        break;
    }
    
    case ColliderType::Ellipse:
    {
        auto* ellipse = static_cast<UIEllipseCollider*>(collider_.get());
        // 半径が{0,0}なら自動設定
        if (ellipse->GetIndependentRadius() == Vector2(0, 0))
        {
            ellipse->SetRadius(ownerSize * 0.5f);
        }
        break;
    }
    
    // Quad, ConvexPolygon は手動設定が前提なので何もしない
    default:
        break;
    }
    
    #ifdef _DEBUG
    if (ownerSize == Vector2(0, 0))
    {
        std::cout << "[Warning] ColliderComponent on '" << owner_->GetName() 
                  << "' auto-set to zero size." << std::endl;
    }
    #endif
}

void ColliderComponent::Update()
{
    assert(collider_ != nullptr);
    
    // UIElementを直接渡してキャッシュ更新
    collider_->UpdateCache(owner_);
    
    // デバッグ描画
    if (debugDraw_)
    {
        collider_->DrawDebug();
    }
}

bool ColliderComponent::IsHit(const Vector2& worldPos) const
{
    assert(collider_ != nullptr);
    return collider_->IsPointInside(worldPos);
}

void ColliderComponent::SetColliderType(ColliderType type)
{
    if (colliderType_ == type) return;
    
    colliderType_ = type;
    collider_ = UIColliderFactory::Create(type);
    
    if (owner_)
    {
        InitializeColliderSize();
    }
}

void ColliderComponent::SetSize(const Vector2& size)
{
    if (colliderType_ == ColliderType::Rectangle)
    {
        auto* rect = static_cast<UIRectangleCollider*>(collider_.get());
        rect->SetLocalSize(size);
    }
}

Vector2 ColliderComponent::GetSize() const
{
    if (colliderType_ == ColliderType::Rectangle)
    {
        auto* rect = static_cast<const UIRectangleCollider*>(collider_.get());
        return rect->GetLocalSize();
    }
    return Vector2(0, 0);
}

void ColliderComponent::SetOffset(const Vector2& offset)
{
    switch (colliderType_)
    {
    case ColliderType::Rectangle:
        static_cast<UIRectangleCollider*>(collider_.get())->SetLocalOffset(offset);
        break;
    case ColliderType::Circle:
        static_cast<UICircleCollider*>(collider_.get())->SetLocalOffset(offset);
        break;
    case ColliderType::Ellipse:
        static_cast<UIEllipseCollider*>(collider_.get())->SetLocalOffset(offset);
        break;
    default:
        break;
    }
}

Vector2 ColliderComponent::GetOffset() const
{
    switch (colliderType_)
    {
    case ColliderType::Rectangle:
        return static_cast<const UIRectangleCollider*>(collider_.get())->GetLocalOffset();
    case ColliderType::Circle:
        return static_cast<const UICircleCollider*>(collider_.get())->GetLocalOffset();
    case ColliderType::Ellipse:
        return static_cast<const UIEllipseCollider*>(collider_.get())->GetLocalOffset();
    default:
        return Vector2(0, 0);
    }
}

void ColliderComponent::DrawImGui()
{
#ifdef USE_IMGUI
    ImGui::Text("ColliderComponent");
    
    // Collider種類変更UI
    auto newCollider = UIColliderFactory::ImGuiSelectCollider(
        colliderType_, 
        "Collider Type"
    );
    
    if (newCollider)
    {
        collider_ = std::move(newCollider);
        InitializeColliderSize();
    }
    
    // Debug Draw
    ImGui::Checkbox("Debug Draw", &debugDraw_);
    
    // Collider固有のImGui
    ImGui::Separator();
    if (collider_)
    {
        collider_->ImGui();
    }
#endif
}

Phase 7: テスト（1-2時間）
7-1. 単体テスト
テストコード例:
cpp// ColliderComponent単体テスト
void TestColliderComponent()
{
    // UIElement作成
    auto element = std::make_unique<UIElement>("TestElement");
    element->SetPosition({100, 100});
    element->SetSize({200, 50});
    
    // Rectangle Collider追加（サイズ自動設定）
    auto* collider = element->AddComponent<ColliderComponent>(ColliderType::Rectangle);
    element->Initialize();
    element->Update();
    
    // テスト：当たり判定
    assert(collider->IsHit({150, 125}));   // 内部
    assert(!collider->IsHit({50, 50}));    // 外部
    
    // Circle Colliderに変更
    collider->SetColliderType(ColliderType::Circle);
    element->Update();
    
    // テスト：円の当たり判定
    assert(collider->IsHit({200, 125}));   // 中心付近
    
    std::cout << "ColliderComponent test passed!" << std::endl;
}
7-2. 統合テスト確認項目

 Rectangle Collider: サイズ自動設定
 Rectangle Collider: 当たり判定
 Circle Collider: サイズ自動設定
 Circle Collider: 当たり判定
 Collider種類の動的変更
 オフセット設定
 デバッグ描画
 ImGuiでのパラメータ調整


作業チェックリスト
必須作業

 Phase 1: IUICollider.h 修正
 Phase 2: UIRectangleCollider 修正
 Phase 3: UICircleCollider 修正
 Phase 5: Parallelogram削除
 Phase 6: ColliderComponent実装
 Phase 7: テスト

オプション作業（必要に応じて）

 Phase 4: UIEllipseCollider 修正
 Phase 4: UIQuadCollider 修正
 Phase 4: UIConvexPolygonCollider 修正


トラブルシューティング
Q: コンパイルエラー「UIBase が見つからない」
A: includeを #include <UI/UIElement.h> に変更したか確認
Q: リンクエラー
A: UIColliderFactory.cpp で Parallelogram 関連を削除したか確認
Q: 当たり判定がずれる
A: GetWorldPosition() が Anchor/Pivot を考慮しているか確認
Q: CircleColliderのサイズが0
A: InitializeColliderSize() が呼ばれているか確認

完了条件
✅ 全てのColliderファイルがコンパイル通過
✅ Parallelogram関連が完全に削除
✅ ColliderComponentが実装完了
✅ Rectangle/Circle Collider が正常動作


推定作業時間

Phase 1-3（必須Collider修正）: 2-3時間
Phase 4（オプションCollider）: 2-3時間
Phase 5（Parallelogram削除）: 30分
Phase 6（ColliderComponent実装）: 2-3時間
Phase 7（テスト）: 1-2時間

合計: 8-12時間（1.5日程度）

以上です。不明点があれば質問してください。再試行Claudeは間違えることがあります。回答内容を必ずご確認ください。 Sonnet 4.5